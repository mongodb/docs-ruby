.. _ruby-get-started:

================================
Get Started with the Ruby Driver
================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 3
   :class: singlecol

.. facet::
   :name: genre
   :values: tutorial
 
.. meta::
   :description: Learn how to create an app to connect to MongoDB deployment by using the Ruby driver.
   :keywords: quick start, tutorial, basics, installation, setup, code example, test connection, runnable

Overview
--------

The {+driver-long+} is a library that allows Ruby applications to interact with
MongoDB databases. You can use the {+driver-short+} to connect to MongoDB and perform
common data operations. This guide shows you how to create an application that uses the
{+driver-short+} to connect to a MongoDB cluster hosted on MongoDB Atlas
and query data in your cluster.

.. tip:: 

   MongoDB Atlas is a fully managed cloud database service that hosts your MongoDB
   deployments. You can create your own free (no credit card required) MongoDB Atlas 
   deployment by following the steps in this guide.

If you prefer to use a different driver or programming language to connect to
MongoDB, see our :driver:`list of official drivers <>`.

.. include:: /includes/get-started/troubleshoot.rst

.. _ruby-quick-start-download-and-install:

Download and Install
--------------------

.. procedure::
   :style: connected

   .. step:: Install dependencies

      Before you begin developing, ensure you install `Ruby
      <https://www.ruby-lang.org/en/downloads/>`__ version 2.7
      or later in your development environment. {+language+}
      is pre-installed on macOS and some Linux distributions,
      but you might need to update your version.

      .. important::

         The {+driver-short+} is not officially supported on Windows.

   .. step:: Create a project directory

      Run the following command in your shell to create a directory
      called ``ruby-quickstart`` for this project:

      .. code-block:: bash

         mkdir ruby-quickstart

      Then, run the following commands to create a ``quickstart.rb`` file in
      the ``ruby-quickstart`` directory:

      .. code-block:: bash

         cd ruby-quickstart
         touch quickstart.rb

   .. step:: Add the {+driver-short+} to your project

      Open the ``quickstart.rb`` file and add the following code:

      .. literalinclude:: /includes/get-started/quickstart.rb
         :language: ruby
         :dedent:
         :start-after: start-bundler
         :end-before: end-bundler

      This code adds the {+driver-short+} as a dependency by
      using the `Bundler <https://bundler.io/>`__ dependency management tool.

After you complete these steps, you have a new project directory with the driver
dependencies installed.

.. _ruby-get-started-create-deployment:

Create a MongoDB Deployment
---------------------------

You can create a free tier MongoDB deployment on MongoDB Atlas
to store and manage your data. MongoDB Atlas hosts and manages
your MongoDB database in the cloud.

.. procedure::
   :style: connected

   .. step:: Create a free MongoDB deployment on Atlas

      Complete the :atlas:`Get Started with Atlas </getting-started>`
      guide to set up a new Atlas account and load sample data into a new free
      tier MongoDB deployment.
      
   .. step:: Save your credentials

      After you create your database user, save that user's 
      username and password to a safe location for use in an upcoming step.
  
After you complete these steps, you have a new free tier MongoDB
deployment on Atlas, database user credentials, and sample data loaded
in your database.

.. _ruby-get-started-connection-string:

Create a Connection String 
--------------------------

You can connect to your MongoDB deployment by providing a
**connection URI**, also called a *connection string*, which
instructs the driver how to connect to a MongoDB deployment
and how to behave while connected.

The connection string includes the hostname or IP address and 
port of your deployment, the authentication mechanism, user credentials 
when applicable, and connection options.

To learn how to connect to an instance or deployment not hosted on
Atlas, see the :ref:`ruby-connection-targets` guide.

.. procedure::
   :style: connected

   .. step:: Find your MongoDB Atlas connection string

      To retrieve your connection string for the deployment that
      you created in the :ref:`previous step <ruby-get-started-create-deployment>`,
      log in to your Atlas account and navigate to the
      :guilabel:`Clusters` section. Then, click the :guilabel:`Connect` button
      for your new deployment.

      .. figure:: /includes/figures/atlas_connection_connect_cluster.png
         :alt: The connect button in the clusters section of the Atlas UI

      Proceed to the :guilabel:`Connect your application` section. Select
      "Ruby" from the :guilabel:`Driver` selection menu and the version
      that best matches your installed version from the :guilabel:`Version`
      selection menu.

   .. step:: Copy your connection string

      Click the copy button on the right of the connection string to copy it to
      your clipboard, as shown in the following screenshot:

      .. figure:: /includes/figures/atlas_connection_copy_string_ruby.png
         :alt: The connection string copy button in the Atlas UI

   .. step:: Update the placeholders

      Paste this connection string into a file in your preferred text editor
      and replace the ``<db_username>`` and ``<db_password>`` placeholders with
      your database user's username and password.
      
      Save this file to a safe location for use in the next step.

After completing these steps, you have a connection string that
contains your database username and password.

.. _ruby-get-started-connect-to-mongodb:

Connect to MongoDB
------------------

.. procedure::
   :style: connected

   .. step:: Edit your {+language+} application file

      Navigate to your ``quickstart.rb`` file in the ``ruby-quickstart``
      directory. Copy and paste the following code below the Bundler
      code from the :ref:`ruby-quick-start-download-and-install` step 
      of this tutorial. This code connects to MongoDB and queries the
      ``movies`` collection in the ``sample_mflix`` database.

      .. literalinclude:: /includes/get-started/quickstart.rb
         :language: ruby
         :dedent:
         :start-after: start-query
         :end-before: end-query

   .. step:: Assign the connection string

      Replace the ``<connection string>`` placeholder with the 
      connection string that you copied from the :ref:`ruby-get-started-connection-string`
      step of this tutorial.

   .. step:: Run your {+language+} application

      From your ``ruby-quickstart`` directory, run the following shell
      command to run the application:
      
      .. code-block:: none

         ruby quickstart.rb

      The command line output contains details about the retrieved movie
      document:

      .. code-block:: none
         :copyable: false

         {"_id"=>BSON::ObjectId('...'), "plot"=>"A young man is accidentally sent
         30 years into the past in a time-traveling DeLorean invented by his friend,
         Dr. Emmett Brown, and must make sure his high-school-age parents unite
         in order to save his own existence.", ...
         "title"=>"Back to the Future", ...

      If you encounter an error or see no output, ensure that you specified the
      correct connection string in the ``quickstart.rb`` file and that you loaded the
      sample data.

After you complete these steps, you have a working application that
uses the driver to connect to your MongoDB deployment, runs a query on
the sample data, and prints out the result.

.. _ruby-databases-collections:

Manage your Databases and Collections
-------------------------------------

You can learn how to use MongoDB databases and
collections with {+driver-short+}.

MongoDB organizes data into a hierarchy of the following levels:

- **Databases**: The top level of data organization in a MongoDB instance.
- **Collections**: MongoDB stores documents in collections. They are analogous to tables in relational databases.
- **Documents**: Contain literal data such as string, numbers, dates, and other embedded documents.

For more information about document field types and structure, see the
:manual:`Documents </core/document/>` guide in the {+mdb-server+} manual.

.. TODO: Add a diagram here

Access a Database
~~~~~~~~~~~~~~~~~

Access a database by creating a ``Mongo::Client`` instance with the desired 
database name.

The following example accesses a database named ``test_database``:

.. literalinclude:: /includes/usage-examples/databases-collection.rb
   :language: ruby
   :dedent:
   :start-after: start-access-db
   :end-before: end-access-db


Access a Collection
~~~~~~~~~~~~~~~~~~~

Access a collection by using the ``[]`` method on an instance 
of your database.

The following example accesses a collection named ``test_collection``:

.. literalinclude:: /includes/usage-examples/databases-collection.rb
   :language: ruby
   :dedent:
   :emphasize-lines: 2
   :start-after: start-access-cl
   :end-before: end-access-cl

.. tip::

   If the provided collection name does not already exist in the database,
   MongoDB implicitly creates the collection when you first insert data
   into it.

Create a Collection
~~~~~~~~~~~~~~~~~~~

While the Ruby driver for MongoDB does not have a direct ``create_collection`` 
method, you can use the ``create`` method to create a collection with
specific options.

The following example creates a collection called example_collection with 
specific options:

.. literalinclude:: /includes/usage-examples/databases-collection.rb
   :language: ruby
   :dedent:
   :emphasize-lines: 3
   :start-after: start-create-collection
   :end-before: end-create-collection

You can specify collection options such as maximum size, document validation 
rules, and others by passing them as arguments to the command method with the 
create command. For a full list of optional parameters, refer to the MongoDB 
documentation on the :manual:`create command </reference/command/create/>`.

Get a List of Collections
~~~~~~~~~~~~~~~~~~~~~~~~~

You can query for a list of collections in a database by calling the ``collections``
method. This method returns an array of collection objects in the database.

The following example calls the ``collections`` method and iterates over the array
to print the results:

.. literalinclude:: /includes/usage-examples/databases-collection.rb
   :language: ruby
   :dedent:
   :start-after: start-get-list
   :end-before: end-get-list

To query for only the names of the collections in the database, call the 
``collection_names`` method as follows:

.. literalinclude:: /includes/usage-examples/databases-collection.rb
   :language: ruby
   :dedent:
   :start-after: start-get-list-names
   :end-before: end-get-list-names

.. note::

   The ``database.collections`` objects list provides more detailed information 
   (i.e. each collection object can be further queried for metadata), while 
   ``database.collection_names`` simply lists the collection names.

Delete a Collection
~~~~~~~~~~~~~~~~~~~

You can delete a collection from the database by using the ``drop`` method.

The following example deletes the ``test_collection`` collection:

.. literalinclude:: /includes/usage-examples/databases-collection.rb
   :language: ruby
   :dedent:
   :start-after: start-delete
   :end-before: end-delete

.. warning:: Dropping a Collection Deletes All Data in the Collection

   Dropping a collection from your database permanently deletes all
   documents and all indexes within that collection.

   Drop a collection only if the data in it is no longer needed. 

.. _ruby-config-read-write:

Configure Read and Write Operations
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can control how the driver routes read operations by setting a **read preference**.
You can also control options for how the driver waits for acknowledgment of
read and write operations on a replica set by setting a **read concern** and a
**write concern**.

By default, databases inherit these settings from the ``Mongo::Client`` instance, 
and collections inherit them from the database. However, you can change these 
settings on your database or collection by using one of the following methods:

- ``database.with``: Gets the database and applies the new read preference, read
  concern, and write concern.
- ``collection.with``: Gets the collection and applies the new read preference,
  read concern, and write concern.

To change read or write settings with the preceding methods, call the method and 
pass in the new read preference, read concern, or write concern. 

The following example shows how to change the read preference, read concern, and
write preference of a database called ``test-database`` with the ``database.with``
method:

.. literalinclude:: /includes/usage-examples/databases-collection.rb
   :language: ruby
   :dedent:
   :start-after: start-with-database
   :end-before: end-with-database

The following example shows how to change the read preference, read concern, and 
write concern of a collection: 

.. literalinclude:: /includes/usage-examples/databases-collection.rb
   :language: ruby
   :dedent:
   :start-after: start-with-collection
   :end-before: end-with-collection

To learn more about the read and write settings, see the following guides in the
MongoDB Server manual:

- :manual:`Read Preference </core/read-preference/>`
- :manual:`Read Concern </reference/read-concern/>`
- :manual:`Write Concern </reference/write-concern/>`

Tag Sets
````````

In {+mdb-server+}, you can apply key-value :manual:`tags
</core/read-preference-tags/>` to replica set
members according to any criteria you choose. You can then use
those tags to target one or more members for a read operation.

By default, the MongoDB {+driver-short+} selects primary members for read operations.
You can modify this behavior by setting read preferences and, optionally, tag sets.

In the following code example, the tag set passed to the ``:read`` parameter
instructs the {+driver-short+} to prefer reads from the New York data center 
(``'dc':'ny'``) and to fall back to the San Francisco data center (``'dc':'sf'``):

.. literalinclude:: /includes/usage-examples/databases-collection.rb
   :language: ruby
   :dedent:
   :start-after: start-tag-sets
   :end-before: end-tag-sets

To learn more about replica sets, see the the MongoDB Server manual 
:manual:`Replica Set Members </core/replica-set-members/>` page.

Local Threshold
````````````````

If multiple replica set members match the read preference and tag sets you specify,
{+driver-short+} reads from the nearest replica set members of sharded clusters, 
chosen according to their ping time.

By default, the driver uses only those members whose ping times are within 15 milliseconds
of the nearest member for queries. To distribute reads between members with
higher latencies, pass the ``local_threshold`` option to the ``Mongo::Client`` constructor.

The following example specifies a local threshold of 35 milliseconds:

.. literalinclude:: /includes/usage-examples/databases-collection.rb
   :language: ruby
   :dedent:
   :start-after: start-local-threshold-example
   :end-before: end-local-threshold-example
   :emphasize-lines: 5

In the preceding example, {+driver-short+} distributes reads between matching members
within 35 milliseconds of the closest member's ping time.

.. note::
  
   {+driver-short+} ignores the value of ``local_threshold`` when communicating with a
   replica set through a ``mongos`` instance. In this case, use the
   :manual:`localThreshold </reference/program/mongos/#std-option-mongos.--localThreshold>`
   command-line option.

API Documentation
~~~~~~~~~~~~~~~~~

To learn more about any of the methods or types discussed in this
guide, see the following API documentation:

- :ruby-api:`collections <Database.html#collections-instance_method>`
- :ruby-api:`collection_names <Database.html#collection_names-instance_method>`
- :ruby-api:`command <Monitoring/Event/CommandStarted.html#command-instance_method>`
- :ruby-api:`drop database <Database.html#drop-instance_method>`
- :ruby-api:`drop collection <Collection.html#drop-instance_method>`
- :ruby-api:`with <Collection.html#with-instance_method>`

.. _ruby-get-started-next-steps:

Next Steps
----------

Congratulations on completing the quick start tutorial!

In this tutorial, you created a {+language+} application that
connects to a MongoDB deployment hosted on MongoDB Atlas
and retrieves a document that matches a query.

Learn more about the {+driver-short+} from the following resources:

- Learn how to perform read operations in the :ref:`<ruby-read>` section.
- Learn how to perform write operations in the :ref:`<ruby-write>` section.
